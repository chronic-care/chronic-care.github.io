<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE HTML>
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
    <title>FHIR.ACEP.COVID19-ED-R4\CQL Library - Summary of results for the ACEP Emergency Department COVID-19 Management Tool - FHIR v4.0.1</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="author" content="http://hl7.org/fhir"/>

    <link href="fhir.css" rel="stylesheet"/>

    <!-- Bootstrap core CSS -->
    <link href="assets/css/bootstrap-fhir.css" rel="stylesheet"/>

    <!-- Project extras -->
    <link href="assets/css/project.css" rel="stylesheet"/>
    <link href="assets/css/pygments-manni.css" rel="stylesheet"/>
    <link href="assets/css/jquery-ui.css" rel="stylesheet"/>
  	<link href="assets/css/prism.css" rel="stylesheet" />
    <!-- Placeholder for child template CSS declarations -->

    <script type="text/javascript" src="fhir-table-scripts.js"> </script>

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="assets/js/html5shiv.js"></script>
    <script src="assets/js/respond.min.js"></script>
    <![endif]-->

    <!-- Favicons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="assets/ico/apple-touch-icon-144-precomposed.png"/>
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="assets/ico/apple-touch-icon-114-precomposed.png"/>
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="assets/ico/apple-touch-icon-72-precomposed.png"/>
    <link rel="apple-touch-icon-precomposed" href="assets/ico/apple-touch-icon-57-precomposed.png"/>
    <link rel="shortcut icon" href="assets/ico/favicon.png"/>
  </head>
  <body onload="document.body.style.opacity='1'">

	  <script src="assets/js/prism.js"></script>

    <style type="text/css">h2{--heading-prefix:"6.43"}
    h3,h4,h5,h6{--heading-prefix:"6.43"}</style>
    <div id="segment-header" class="segment">  <!-- segment-header -->
      <div class="container">  <!-- container -->
        <!-- Placeholder for child template header declarations -->


        <div id="ig-status">
          <p><span style="font-size:12pt;font-weight:bold">Emergency Department COVID-19 Severity Classification</span><br/>0.1.0 - CI Build</p>
        </div>
      </div> <!-- /container -->
    </div>  <!-- /segment-header -->

    <div id="segment-navbar" class="segment">  <!-- segment-navbar -->
      <div id="stripe"> </div>
      <div class="container">  <!-- container -->
        <!-- HEADER CONTENT -->

        <nav class="navbar navbar-inverse">
          <!--status-bar-->
          <div class="container">
            <button data-target=".navbar-inverse-collapse" class="navbar-toggle" data-toggle="collapse" type="button">
              <span class="icon-bar"> </span>
              <span class="icon-bar"> </span>
              <span class="icon-bar"> </span>
            </button>
            <a class="navbar-brand hidden" href="http://hl7.org/fhir/R4/index.html">FHIR</a>
            <div class="nav-collapse collapse navbar-inverse-collapse">
              <ul xmlns="http://www.w3.org/1999/xhtml" class="nav navbar-nav">
  <li><a href="index.html">IG Home</a></li>
  <li><a href="toc.html">Table of Contents</a></li>
  <li class="dropdown">
    <a data-toggle="dropdown" href="#" class="dropdown-toggle">Background<b class="caret">
      </b>
    </a>
    <ul class="dropdown-menu">
      <li>
        <a href="background.html">Background</a>
      </li>
    </ul>
  </li>
  <li class="dropdown">
    <a data-toggle="dropdown" href="#" class="dropdown-toggle">Specification<b class="caret">
      </b>
    </a>
    <ul class="dropdown-menu">
      <li>
        <a href="spec.html">Detailed Specification</a>
      </li>
    </ul>
  </li>
  <li><a href="artifacts.html">Artifact Index</a></li>
  <li class="dropdown">
    <a data-toggle="dropdown" href="#" class="dropdown-toggle">Support<b class="caret">
      </b>
    </a>
    <ul class="dropdown-menu">
      <li>
        <a target="_blank" href="http://hl7.org/fhir/R4/index.html">FHIR Spec <img src="external.png" style="text-align: baseline"/></a>
      </li>
      <li>
        <a href="downloads.html">Downloads</a>
      </li>
    </ul>
  </li>
</ul>

            </div>  <!-- /.nav-collapse -->
          </div>  <!-- /.container -->
        </nav>  <!-- /.navbar -->
      <!-- /HEADER CONTENT -->
      </div>  <!-- /container -->
    </div>  <!-- /segment-navbar -->
    <!--status-bar-->

    <div id="segment-breadcrumb" class="segment">  <!-- segment-breadcrumb -->
      <div class="container">  <!-- container -->
        <ul class="breadcrumb">
          <li><a href='toc.html'><b>Table of Contents</b></a></li><li><a href='artifacts.html'><b>Artifacts Summary</b></a></li><li><b>CQL Library - Summary of results for the ACEP Emergency Department COVID-19 Management Tool</b></li>

        </ul>
      </div>  <!-- /container -->
    </div>  <!-- /segment-breadcrumb -->

    <a name="top"> </a>
    <div id="segment-content" class="segment">  <!-- segment-content -->
      <div class="container">  <!-- container -->
        <div class="row">
          <div class="inner-wrapper">

<div class="col-12">
  <!--ReleaseHeader--><p id="publish-box">Emergency Department COVID-19 Severity Classification - Local Development build (v0.1.0). See the <a href="http://fhir.org/guides/acep/history.html">Directory of published versions</a></p><!--EndReleaseHeader-->

  






<ul class="nav nav-tabs">

  <li class="active">
    <a href="#">Narrative Content</a>
  </li>


  
    <li>
      <a href="Library-COVID19EmergencyDeptSummary.xml.html">XML</a>
    </li>
  


  
    <li>
      <a href="Library-COVID19EmergencyDeptSummary.json.html">JSON</a>
    </li>
  




</ul>


  <a name="root"> </a>


  <h2 id="root">Library: CQL Library - Summary of results for the ACEP Emergency Department COVID-19 Management Tool</h2>


  


  <!-- insert intro if present -->
  



  <div xmlns="http://www.w3.org/1999/xhtml"><h2>Related Artifacts</h2><table class="grid"><tr><td>depends-on</td><td><code>http://hl7.org/fhir/Library/FHIR-ModelInfo|4.0.1</code></td></tr><tr><td>depends-on</td><td><code>http://fhir.org/guides/acep/Library/COVID19EmergencyDeptAssessment|1.0.0</code></td></tr><tr><td>depends-on</td><td><code>http://fhir.org/guides/acep/Library/CDSConnectCommons|1.0.3</code></td></tr><tr><td>depends-on</td><td><code>http://hl7.org/fhir/Library/FHIRHelpers|4.0.1</code></td></tr></table><h2>Parameters</h2><table class="grid"><tr><td>Patient</td><td>out</td><td>0</td><td>1</td><td>Patient</td></tr><tr><td>PatientName</td><td>out</td><td>0</td><td>1</td><td>string</td></tr><tr><td>PatientSummary</td><td>out</td><td>0</td><td>1</td><td>Any</td></tr><tr><td>DiagnosticSummary</td><td>out</td><td>0</td><td>1</td><td>Any</td></tr><tr><td>LabResultList</td><td>out</td><td>0</td><td>*</td><td>Any</td></tr><tr><td>ConcerningLabCount</td><td>out</td><td>0</td><td>1</td><td>decimal</td></tr><tr><td>ConcerningImagingCount</td><td>out</td><td>0</td><td>1</td><td>integer</td></tr><tr><td>DiagnosticInterpretation</td><td>out</td><td>0</td><td>1</td><td>decimal</td></tr><tr><td>RiskSummary</td><td>out</td><td>0</td><td>1</td><td>Any</td></tr><tr><td>SmartPhrases</td><td>out</td><td>0</td><td>1</td><td>Any</td></tr><tr><td>LabResultCount</td><td>out</td><td>0</td><td>1</td><td>decimal</td></tr><tr><td>ImagingResultList</td><td>out</td><td>0</td><td>*</td><td>boolean</td></tr><tr><td>ImagingResultCount</td><td>out</td><td>0</td><td>1</td><td>integer</td></tr><tr><td>Recommend Obtain Diagnostics</td><td>out</td><td>0</td><td>1</td><td>boolean</td></tr><tr><td>ConcerningLabsOrImaging</td><td>out</td><td>0</td><td>1</td><td>boolean</td></tr><tr><td>Recommend Discharge Home</td><td>out</td><td>0</td><td>1</td><td>boolean</td></tr><tr><td>Recommend Discharge Home Elevated Risk</td><td>out</td><td>0</td><td>1</td><td>boolean</td></tr><tr><td>Recommend Consider Admission</td><td>out</td><td>0</td><td>1</td><td>boolean</td></tr><tr><td>Recommend Consider Discharging Home</td><td>out</td><td>0</td><td>1</td><td>boolean</td></tr><tr><td>Recommend Severe Admission</td><td>out</td><td>0</td><td>1</td><td>boolean</td></tr><tr><td>Recommend Critical Admission</td><td>out</td><td>0</td><td>1</td><td>boolean</td></tr><tr><td>DispositionSummary</td><td>out</td><td>0</td><td>1</td><td>Any</td></tr><tr><td>HasAdmissionOrDischargeRecommendation</td><td>out</td><td>0</td><td>1</td><td>boolean</td></tr><tr><td>Recommend Non-Pharmacologic Treatment</td><td>out</td><td>0</td><td>1</td><td>boolean</td></tr><tr><td>Recommend Discharge Treatment</td><td>out</td><td>0</td><td>1</td><td>boolean</td></tr><tr><td>Recommend Admission Treatment</td><td>out</td><td>0</td><td>1</td><td>boolean</td></tr><tr><td>Recommend Steroids Treatment</td><td>out</td><td>0</td><td>1</td><td>boolean</td></tr><tr><td>TreatmentSummary</td><td>out</td><td>0</td><td>1</td><td>Any</td></tr><tr><td>AssessmentSummary</td><td>out</td><td>0</td><td>1</td><td>Any</td></tr><tr><td>RiskFactorSummary</td><td>out</td><td>0</td><td>1</td><td>Any</td></tr></table><h2>Contents</h2><p><code>text/cql</code></p><pre><code>// # Introduction

// ACEP Emergency Department COVID-19 Management Tool

library COVID19EmergencyDeptSummary version '1.0.0'

// # Data model #

using FHIR version '4.0.1'

// # Referenced libraries #

// Logic for the ACEP Emergency Department COVID-19 Management Tool
include COVID19EmergencyDeptAssessment version '1.0.0' called C19
// The CDS Connect Commons library provides functions representing commonly used CDS logic and patterns.
include CDSConnectCommons version '1.0.3' called C3F
// The FHIRHelpers library provides common functions for simplifying interaction w/ the FHIR R4 data model.
include FHIRHelpers version '4.0.1'

context Patient

// The Summary objects represent the COVID-19 assessments and risk scores to be displayed to the clinician.  All values are
// returned as user-friendly text representations.

define PatientSummary: {
  Name: PatientName,
  Gender: Patient.gender.value,
  BirthSex: C19.&quot;Patient Birth Sex&quot;,
  Age: AgeInYears(),
  Race: C19.&quot;Patient Race Text&quot;
}

define RiskSummary: {
  SeverityClassification: Message(C19.&quot;Severity Classification&quot;, true, 'Undefined', 'Trace', 'Calculating C19.&quot;Severity Classification&quot;'),
  Saturation: Message(C19.&quot;O2 Saturation Risk Score&quot;, true, 'Undefined', 'Trace', 'Calculating C19.&quot;O2 Saturation Risk Score&quot;'),
  HeartRate: Message(C19.&quot;Heart Rate Risk Score&quot;, true, 'Undefined', 'Trace', 'Calculating C19.&quot;Heart Rate Risk Score&quot;'),
  Respirtory: Message(C19.&quot;Respiratory Rate Risk Score&quot;, true, 'Undefined', 'Trace', 'Calculating C19.&quot;Respiratory Rate Risk Score&quot;'),
  Temperature: Message(C19.&quot;Temperature Risk Score&quot;, true, 'Undefined', 'Trace', 'Calculating C19.&quot;Temperature Risk Score&quot;'),
  Alertness: Message(C19.&quot;Alertness Score&quot;, true, 'Undefined', 'Trace', 'Calculating C19.&quot;Alertness Score&quot;'),
  Oxygen: Message(C19.&quot;Inspired Oxygen Score&quot;, true, 'Undefined', 'Trace', 'Calculating C19.&quot;Inspired Oxygen Score&quot;'),
  Sex: Message(C19.&quot;Sex Risk Score&quot;, true, 'Undefined', 'Trace', 'Calculating C19.&quot;Sex Risk Score&quot;'),
  Age: Message(C19.&quot;Age Risk Score&quot;, true, 'Undefined', 'Trace', 'Calculating C19.&quot;Age Risk Score&quot;'),
  PerformanceStatus: Message(C19.&quot;Performance Status Score&quot;, true, 'Undefined', 'Trace', 'Calculating C19.&quot;Performance Status Score&quot;'),
  BloodPressure: Message(C19.&quot;Systolic BP Risk Score&quot;, true, 'Undefined', 'Trace', 'Calculating &quot;Systolic BP Risk Score&quot;'),
  RiskScore: Message(C19.&quot;Total Risk Score&quot;, true, 'Undefined', 'Trace', 'Calculating C19.&quot;Total Risk Score&quot;'),
  RiskPercent: Message(C19.&quot;Risk Percent&quot;, true, 'Undefined', 'Trace', 'Calculating C19.&quot;Risk Percent&quot;'),
  RiskFactorCount: Message(C19.&quot;Risk Factors count&quot;, true, 'Undefined', 'Trace', 'Calculating C19.&quot;Risk Factors count&quot;'),
  DiagnosticInterpretation: Message(DiagnosticInterpretation, true, 'Undefined', 'Trace', 'Calculating DiagnosticInterpretation'),
  ConcerningLabCount: Message(ConcerningLabCount, true, 'Undefined', 'Trace', 'Calculating ConcerningLabCount'),
  ConcerningImagingCount: Message(ConcerningImagingCount, true, 'Undefined', 'Trace', 'Calculating ConcerningImagingCount')
}

define SmartPhrases: {
  Severity: 'Based on the criteria present at the time of evaluation, the patient was determined to have ' + RiskSummary.SeverityClassification + ' Severity.',
  RiskPrognostication: 'Based on a PRIEST Score of ' + ToString(RiskSummary.RiskScore) + ' the patient is estimated to have a ' + ToString(RiskSummary.RiskPercent) + '% risk.',
  RiskAssessment: case RiskSummary.RiskFactorCount
    when null then null
    when 0 then 'Patient did not have any additional risk factors based on those included within this tool.'
    when 1 then 'Patient was noted to have an additional risk factor.'
    else 'Patient was noted to have 2 (or more) additional risk factors.'
    end
}

define DispositionSummary: {
  ObtainDiagnostics: &quot;Recommend Obtain Diagnostics&quot;,
  DischargeHome: &quot;Recommend Discharge Home&quot;,
  DischargeHomeElevatedRisk: &quot;Recommend Discharge Home Elevated Risk&quot;,
  ConsiderAdmission: &quot;Recommend Consider Admission&quot;,
  ConsiderDischargingHome: &quot;Recommend Consider Discharging Home&quot;,
  SevereAdmission: &quot;Recommend Severe Admission&quot;,
  CriticalAdmission: &quot;Recommend Critical Admission&quot;
}

// Value: true and false, null
define TreatmentSummary: {
    NonPharmacologic: &quot;Recommend Non-Pharmacologic Treatment&quot;,
    Discharge: &quot;Recommend Discharge Treatment&quot;,
    Admission: &quot;Recommend Admission Treatment&quot;,
    Steroids: &quot;Recommend Steroids Treatment&quot;
}

define AssessmentSummary: {
  RespiratoryRate: C19.&quot;Last Respiratory Rate value&quot;,
  O2Saturation: C19.&quot;Last O2 Saturation percent&quot;,
  HeartRate: C19.&quot;Last Heart Rate value&quot;,
  BloodPressure: C19.&quot;Last Blood Pressure&quot;.Display,
  SystolicBloodPressure: C19.&quot;Last SBP value&quot;,
  TemperatureC: C19.&quot;Last Body Temperature value in C&quot;,
  TemperatureF: C19.&quot;Last Body Temperature value in F&quot;,
  SupplementalOxygen: C19.ClinicalAssessments.SupplementalOxygen,
  Alertness: C19.&quot;Alertness Assessment Code&quot;,
  PerformanceStatus: C19.&quot;Performance Status Code&quot;
}

define RiskFactorSummary: {
    Bronchiectasis: C19.&quot;Has Bronchiectasis Risk Factor&quot;,
    BronchopulmonaryDysplasia: C19.&quot;Has Bronchopulmonary Dysplasia Risk Factor&quot;,
    PulmonaryHypertension: C19.&quot;Has Pulmonary Hypertension Risk Factor&quot;,
    PulmonaryEmbolism: C19.&quot;Has Pulmonary Embolism Risk Factor&quot;,
    Cancer: C19.&quot;Has Cancer Risk Factor&quot;,
    CerebrovascularDisease: C19.&quot;Has Cerebrovascular Disease Risk Factor&quot;,
    ChronicKidneyDisease: C19.&quot;Has Chronic Kidney Disease Risk Factor&quot;,
    ChronicLiverDisease: C19.&quot;Has Chronic Liver Disease Risk Factor&quot;,
    COPD: C19.&quot;Has COPD Risk Factor&quot;,
    DiabetesMellitus: C19.&quot;Has Diabetes Mellitus Risk Factor&quot;,
    HeartConditions: C19.&quot;Has Heart Conditions Risk Factor&quot;,
    InterstitialLungDisease: C19.&quot;Has Interstitial Lung Disease Risk Factor&quot;,
    CurrentAndFormerSmoking: C19.&quot;Has Current And Former Smoking Risk Factor&quot;,
    Tuberculosis: C19.&quot;Has Tuberculosis Risk Factor&quot;,
    Obesity: C19.&quot;Has Obesity Risk Factor&quot;,
    PregnancyAndRecentPregnancy: C19.&quot;Has Pregnancy And Recent Pregnancy Risk Factor&quot;,
    MentalHealthDisorders: C19.&quot;Has Mental Health Disorders Risk Factor&quot;,
    ChildrenWithCertainUnderlyingConditions: C19.&quot;Has Children With Certain Underlying Conditions Risk Factor&quot;,
    DownSyndrome: C19.&quot;Has Down Syndrome Risk Factor&quot;,
    HIV: C19.&quot;Has HIV Risk Factor&quot;,
    NeurologicConditions: C19.&quot;Has Neurologic Conditions Risk Factor&quot;,
    Overweight: C19.&quot;Has Overweight Risk Factor&quot;,
    SickleCellDisease: C19.&quot;Has Sickle Cell Disease Risk Factor&quot;,
    SolidOrganOrBloodStemTransplantation: C19.&quot;Has Solid Organ Or Blood Stem Transplantation Risk Factor&quot;,
    SubstanceUseDisorders: C19.&quot;Has Substance Use Disorders Risk Factor&quot;,
    Corticosteroids: C19.&quot;Has Corticosteroids Usage Risk Factor&quot;,
    ImmunosuppressiveMedications: C19.&quot;Has Immunosuppressive Medications Risk Factor&quot;,
    CysticFibrosis: C19.&quot;Has Cystic Fibrosis Risk Factor&quot;,
    Thalassemia: C19.&quot;Has Thalassemia Risk Factor&quot;,
    Asthma: C19.&quot;Has Asthma Risk Factor&quot;,
    Hypertension: C19.&quot;Has Hypertension Risk Factor&quot;,
    ImmuneDeficiencies: C19.&quot;Has Immune deficiencies Risk Factor&quot;
}

define DiagnosticSummary: {
  ALT: Message(ReportLabObservation(C19.&quot;Last ALT Lab Result&quot;), true, 'Undefined', 'Trace', 'Calculating ReportLabObservation(C19.&quot;Last ALT Lab Result&quot;)'),
  AST: Message(ReportLabObservation(C19.&quot;Last AST Lab Result&quot;), true, 'Undefined', 'Trace', 'Calculating ReportLabObservation(C19.&quot;Last AST Lab Result&quot;)'),
  Creatinine: Message(ReportLabObservation(C19.&quot;Last Creatinine Lab Result&quot;), true, 'Undefined', 'Trace', 'Calculating ReportLabObservation(C19.&quot;Last Creatinine Lab Result&quot;)'),
  CRP: Message(ReportLabObservation(C19.&quot;Last CRP Lab Result&quot;), true, 'Undefined', 'Trace', 'Calculating ReportLabObservation(C19.&quot;Last CRP Lab Result&quot;)'),
  DDimer: Message(ReportLabObservation(C19.&quot;Last D-dimer Lab Result&quot;), true, 'Undefined', 'Trace', 'Calculating ReportLabObservation(C19.&quot;Last D-dimer Lab Result&quot;)'),
  Ferritin: Message(ReportLabObservation(C19.&quot;Last Ferritin Lab Result&quot;), true, 'Undefined', 'Trace', 'Calculating ReportLabObservation(C19.&quot;Last Ferritin Lab Result&quot;)'),
  LDH: Message(ReportLabObservation(C19.&quot;Last LDH Lab Result&quot;), true, 'Undefined', 'Trace', 'Calculating ReportLabObservation(C19.&quot;Last LDH Lab Result&quot;)'),
  Lymphopenia: Message(ReportLabObservation(C19.&quot;Last Lymphocytes Lab Result&quot;), true, 'Undefined', 'Trace', 'Calculating ReportLabObservation(C19.&quot;Last Lymphocytes Lab Result&quot;)'),
  Neutrophils: Message(ReportLabObservation(C19.&quot;Last Neutrophils Lab Result&quot;), true, 'Undefined', 'Trace', 'Calculating ReportLabObservation(C19.&quot;Last Neutrophils Lab Result&quot;)'),
  Thrombocytopenia: Message(ReportLabObservation(C19.&quot;Last Platelets Lab Result&quot;), true, 'Undefined', 'Trace', 'Calculating ReportLabObservation(C19.&quot;Last Platelets Lab Result&quot;)'),
  Troponin: Message(ReportLabObservation(C19.&quot;Last Troponin Lab Result&quot;), true, 'Undefined', 'Trace', 'Calculating ReportLabObservation(C19.&quot;Last Troponin Lab Result&quot;)'),
  WBC: Message(ReportLabObservation(C19.&quot;Last Leukocyte Lab Result&quot;), true, 'Undefined', 'Trace', 'Calculating ReportLabObservation(C19.&quot;Last Leukocyte Lab Result&quot;)'),

  // Not included in count of concerning labs; used for severity classification.
  PaO2FiO2: Message(C19.&quot;Last PaO2FiO2 Ratio Lab Result Less Than 300&quot;, true, 'Undefined', 'Trace', 'Calculating C19.&quot;Last PaO2FiO2 Ratio Lab Result Less Than 300&quot;')
}

define LabResultList: {
  DiagnosticSummary.ALT,
  DiagnosticSummary.AST,
  DiagnosticSummary.Creatinine,
  DiagnosticSummary.CRP,
  DiagnosticSummary.DDimer,
  DiagnosticSummary.Ferritin,
  DiagnosticSummary.LDH,
  DiagnosticSummary.Lymphopenia,
  DiagnosticSummary.Neutrophils,
  DiagnosticSummary.Thrombocytopenia,
  DiagnosticSummary.Troponin,
  DiagnosticSummary.WBC
}

define ImagingResultList: {
  C19.ClinicalAssessments.ChestXRayConcerning,
  C19.ClinicalAssessments.UltrasoundConcerning,
  C19.ClinicalAssessments.CTConcerning
}

define LabResultCount:
  Message(

    if (C19.ClinicalAssessments.ConcerningLabCount is not null and C19.ClinicalAssessments.ConcerningLabCount = 0) then 1
    else if (C19.ClinicalAssessments.ConcerningLabCount is not null) then C19.ClinicalAssessments.ConcerningLabCount
    /* else if not exists LabResultList then null */
    else Count(LabResultList result where result is not null)

  , true, 'Undefined', 'Trace', 'Calculating LabResultCount')

define ImagingResultCount:
  /* if not exists ImagingResultList then null
  else  */
  Message(
  Count(ImagingResultList result where result is not null)
  , true, 'Undefined', 'Trace', 'Calculating ImagingResultCount')

// TODO Always returns count of 0 or 1 in Javascript engine... Bug?
/*
define ConcerningImagingCount:
  Count(ImagingResultList result where result is true)
*/

define ConcerningImagingCount:
  /* if not exists ImagingResultList then null
  else */
  Message(
  (if C19.ClinicalAssessments.ChestXRayConcerning is true then 1 else 0)
    + (if C19.ClinicalAssessments.UltrasoundConcerning is true then 1 else 0)
    + (if C19.ClinicalAssessments.CTConcerning is true then 1 else 0)
  , true, 'Undefined', 'Trace', 'Calculating ConcerningImagingCount')

define ConcerningLabCount:
  /* if (not exists LabResultList and C19.ClinicalAssessments.ConcerningLabCount is null) then null
  else */
  Message(
  Coalesce(
    C19.ClinicalAssessments.ConcerningLabCount,
    Count(LabResultList result where result.Flag is true)
  )
  , true, 'Undefined', 'Trace', 'Calculating ConcerningLabCount')

define ConcerningLabsOrImaging:
  ConcerningLabCount &gt;= 1 or ConcerningImagingCount &gt;= 1

define DiagnosticInterpretation:
    ConcerningLabCount + ConcerningImagingCount

/*
define TrendData: {
  RespiratoryRate: ReportObservations(C19.&quot;Respiratory Rate Observations&quot;),
  O2Saturation: ReportObservations(C19.&quot;O2 Saturation Observations&quot;),
  HeartRate: ReportObservations(C19.&quot;Heart Rate Observations&quot;),
  BloodPressure: C19.&quot;Blood Pressure Observations&quot;,
  Temperature: C19.&quot;Body Temperature Observations&quot;    // TODO convert all to degF
}
*/

/*
 * Disposition Recommendations
 */

define &quot;Recommend Obtain Diagnostics&quot;:
  if (LabResultCount &lt; 1 and ImagingResultCount &lt; 1)
    and ((C19.&quot;Is Mild Severity&quot; and (C19.&quot;Total Risk Score&quot; &gt;= 5 or C19.&quot;Risk Factors count&quot; &gt; 1))
        or (C19.&quot;Is Moderate Severity&quot; or C19.&quot;Is Severe Severity&quot; or C19.&quot;Is Critical Severity&quot;))
  then true
  else false

define &quot;Recommend Discharge Home&quot;:
  if C19.&quot;Is Mild Severity&quot;
    and C19.&quot;Total Risk Score&quot; &lt;= 4
    and C19.&quot;Risk Factors count&quot; &lt;= 1
    and ConcerningLabsOrImaging is false
  then true
  else false

define &quot;Recommend Discharge Home Elevated Risk&quot;:
  if C19.&quot;Is Mild Severity&quot;
    and (C19.&quot;Total Risk Score&quot; &gt; 4
        or C19.&quot;Risk Factors count&quot; &gt; 1)
    and ConcerningLabsOrImaging is false
  then true
  else false

define &quot;Recommend Consider Discharging Home&quot;:
  if C19.&quot;Is Moderate Severity&quot;
    and C19.&quot;Total Risk Score&quot; &lt;= 4
    and C19.&quot;Risk Factors count&quot; &lt;= 1
    and ConcerningLabsOrImaging is false
    and (LabResultCount &gt;= 1 or ImagingResultCount &gt;= 1)
  then true
  else false

define &quot;Recommend Consider Admission&quot;:
  if (C19.&quot;Is Mild Severity&quot;
      and ConcerningLabsOrImaging is true
      and (LabResultCount &gt;= 1 or ImagingResultCount &gt;= 1)
    )
    or (C19.&quot;Is Moderate Severity&quot;
        and (ConcerningLabsOrImaging is true
            or C19.&quot;Total Risk Score&quot; &gt; 4
            or C19.&quot;Risk Factors count&quot; &gt; 1)
        and (LabResultCount &gt;= 1 or ImagingResultCount &gt;= 1)
      )
  then true
  else false

define &quot;Recommend Severe Admission&quot;:
  C19.&quot;Is Severe Severity&quot;

define &quot;Recommend Critical Admission&quot;:
  Message(
  C19.&quot;Is Critical Severity&quot;
  , true, 'Undefined', 'Trace', 'Calculating Recommend Critical Admission')

/*
 * Treatment Recommendations
 */
// TODO is there a better CQL syntax for enum literals, e.g. for each code in a ValueSet?
// Value: use, do-not-use, insufficient-evidence, null

// DispositionSummary includes a recommendation, other than ObtainDiagnostics.
define HasAdmissionOrDischargeRecommendation:
  DispositionSummary.ConsiderAdmission or DispositionSummary.SevereAdmission or DispositionSummary.CriticalAdmission
  or DispositionSummary.DischargeHome or DispositionSummary.ConsiderDischargingHome or DispositionSummary.DischargeHomeElevatedRisk

define &quot;Recommend Non-Pharmacologic Treatment&quot;:
  if HasAdmissionOrDischargeRecommendation is false then null
  else true

// Pharmacologic Treatment
// Recommend discharge from emergency department treamtment for mild and moderate severity.
define &quot;Recommend Discharge Treatment&quot;:
  if HasAdmissionOrDischargeRecommendation is false then null
  else if (C19.&quot;Is Mild Severity&quot; or C19.&quot;Is Moderate Severity&quot;) then true
  else null

// Recommend admission to emergency department treamtment for moderate, severe and critical severity.
define &quot;Recommend Admission Treatment&quot;:
  if HasAdmissionOrDischargeRecommendation is false then null
  else if (C19.&quot;Is Moderate Severity&quot; or C19.&quot;Is Severe Severity&quot; or C19.&quot;Is Critical Severity&quot;) then true
  else null

//Do not use steriods for mild and moderate severity
define &quot;Recommend Steroids Treatment&quot;:
  if HasAdmissionOrDischargeRecommendation is false then null
  else if (C19.&quot;Is Mild Severity&quot; or C19.&quot;Is Moderate Severity&quot;) then false
  else null

/*
 * Helper functions for summary reporting.
*/

// Returns the first-found display text for a CodeableConcept, looking first at the `text` attribute, then the
// `display` on each `coding` until it finds a non-null value.
// @param c - a FHIR CodeableConcept to get text from
// @returns {System.String} the display text or null if none is found
define function ConceptText(c FHIR.CodeableConcept):
  Coalesce(c.text.value, Coalesce((c.coding) c2 return c2.display.value), Coalesce((c.coding) c3 return c3.code.value))

// Returns a text representation of a Quantity with the Quantity's value and unit.
// If the unit is {score}, then omit it (as it is not useful to display)
// @param q - a FHIR Quantity to get text for
// @returns {System.String} the text representation of the Quantity
define function QuantityText(q FHIR.Quantity):
  if (q is null) then null
  else if (q.unit is not null and q.unit.value != '{score}') then ToString(q.value.value) + ' ' + q.unit.value
  else if (q.code is not null and q.code.value != '{score}') then ToString(q.value.value) + ' ' + q.code.value
  else ToString(q.value.value)

define PatientName:
  Coalesce(Patient.name[0].text.value,
    (Combine(Patient.name.given G return G.value, ' ') + ' ' + Combine(Patient.name.family F return F.value, ' '))
  )

// Returns a list of observation view Tuples.
define function ReportObservations(ObsList List&lt;Observation&gt;):
  ObsList o
    return {   // result decimal value
      Date:   ToString(C3F.FindDate(o)),
      // Omit display name because observations are in a typed collection
      Name:   ConceptText(o.code),                                // display nanme
      Result: QuantityText(o.value as FHIR.Quantity),             // result value with units
      ResultValue: ToString((o.value as FHIR.Quantity).value)
    }
    sort by Date asc

define function ReportLabObservation(o FHIR.Observation):
  if (o is null or o.value is null or o.value.value is null) then null
  else
    {
      Date:   ToString(C3F.FindDate(o)),
      Name:   ConceptText(o.code),                                // display nanme
      ResultText: QuantityText(o.value as FHIR.Quantity),         // result value with units
      ResultValue: System.Quantity { value: (o.value as FHIR.Quantity).value}.value,
      ResultUnits: (o.value as FHIR.Quantity).unit.value,
      ReferenceRange: LabReferenceRange(o),
      Interpretation: LabInterpretation(o),
      Flag: LabReferenceRangeFlag(o)   // true if value out of range, else false
    }

define function LabReferenceRange(o FHIR.Observation):
  if (o is null or o.referenceRange is null) then null
  else
    Coalesce(First(o.referenceRange.text),
      ToString(LabReferenceRangeLow(o)) + ' - ' + ToString(LabReferenceRangeHigh(o))
    )

define function LabReferenceRangeLow(o FHIR.Observation):
  First(o.referenceRange).low.value

define function LabReferenceRangeHigh(o FHIR.Observation):
  First(o.referenceRange).high.value

define function LabReferenceRangeFlag(o FHIR.Observation):
  if (o.value.value &lt; LabReferenceRangeLow(o)
      or o.value.value &gt; LabReferenceRangeHigh(o)) then true
  else false

define function LabInterpretation(o FHIR.Observation):
  if (o.interpretation is not null) then
    Coalesce(First(o.interpretation.text), First(First(o.interpretation).coding.display))
  else if o.referenceRange is not null then
    // Derive interpretation from the reference range, return null if within normal range.
    if o.value.value &lt; LabReferenceRangeLow(o) then 'L'
    else if o.value.value &gt; LabReferenceRangeHigh(o) then 'H'
    else null
  else
    null
</code></pre><p><code>Content not shown - (</code><code>application/elm+xml</code>, size = 123Kb)</p><p><code>Content not shown - (</code><code>application/elm+json</code>, size = 233Kb)</p></div>

  <!-- insert notes if present -->
  



</div>
        </div>  <!-- /inner-wrapper -->
      </div>  <!-- /row -->
    </div>  <!-- /container -->
  </div>  <!-- /segment-content -->

  <script type="text/javascript" src="assets/js/jquery.js"> </script>     <!-- note keep space here, otherwise it will be transformed to empty tag -> fails -->
  <script type="text/javascript" src="assets/js/jquery-ui.min.js"> </script>

  <script type="text/javascript">
    $(document).ready(function(){
      if(window.location.hash != "") {
          $('a[href="' + window.location.hash + '"]').click()
      }
    });
  </script>
  <a name="bottom"> </a>
  <div id="segment-footer" igtool="footer" class="segment">  <!-- segment-footer -->
    <div class="container">  <!-- container -->

      <div class="inner-wrapper">
        <p>
          IG &#169; 2020+ <a style="color:var(--footer-hyperlink-text-color)" href="http://hl7.org/Special/committees/[something]">Veterans Health Administration (VHA)</a>.  Package fhir.acep.covid19-ed-r4#0.1.0 based on <a style="color: var(--footer-hyperlink-text-color)" href="http://hl7.org/fhir/R4/">FHIR 4.0.1</a>. Generated <span title="Wed, Feb 2, 2022 21:23+0000">2022-02-02</span>
          <br/>
          <span style="color: var(--footer-highlight-text-color)"></span>
                      Links: <a style="color: var(--footer-hyperlink-text-color)" href="toc.html">Table of Contents</a> |
                 <a style="color: var(--footer-hyperlink-text-color)" href="qa.html">QA Report</a>
                 
                
          </span>
        </p>
      </div>  <!-- /inner-wrapper -->
    </div>  <!-- /container -->
  </div>  <!-- /segment-footer -->
  
  <div id="segment-post-footer" class="segment hidden">  <!-- segment-post-footer -->
    <div class="container">  <!-- container -->
    </div>  <!-- /container -->
  </div>  <!-- /segment-post-footer -->
  
  <!-- JS and analytics only. -->
  <!-- Bootstrap core JavaScript
  ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->
  <script type="text/javascript" src="assets/js/bootstrap.min.js"> </script>
  <script type="text/javascript" src="assets/js/respond.min.js"> </script>
  <script type="text/javascript" src="assets/js/anchor.min.js"> </script>
  <script>anchors.options.visible = 'hover'
anchors.add()</script>
  
<!-- feedback form - Google forms -->
<!-- v0.1, 2021-01-09 -->



<!-- / feedback form  -->

  <!-- Analytics Below
  ================================================== -->
  </body>
</html>

